function getWorks(){autoComplete=new AutoComplete("publish-works-input",top_works_list,setAutoCompleteTop1,allelement)}function getIp(){autoComplete=new AutoComplete("publish-ip-input",top_ip_list,setAutoCompleteTop2,allelement)}function getBrand(){autoComplete=new AutoComplete("publish-brand-input",top_brand_list,setAutoCompleteTop2,allelement)}function hideAutoComplete(){deleteAutoComplete(allelement)}function makeBlurBg(a){for(var b=$("#container"),c=b.width(),d=b.height(),e=a.getContext("2d"),f=e.getImageData(0,0,c,d),g=StackBlur.imageDataRGBA(f,0,0,c,d,16),h=g.data,i=.7,j=0;j<h.length;j+=4)h[j]*=i,h[j+1]*=i,h[j+2]*=i,h[j+3]=229.5;e.putImageData(g,0,0)}function setMain(a){if(1!==a){var b=$("#publish-img-slick"),c=$(b.find(".publish-img")[a-1]),d=$(c).css("background-image").replace("url(","").replace("!thumb)","!content"),e=$("#publish-main-img").find("> img");e.fadeOut(500,function(){e.attr("src",d),e.fadeIn(500)});var f=c.clone();b.slick("slickRemove",a),b.slick("slickAdd",f,0);var g=b.find(".publish-img:first"),h=$($("#publish-main-img-label-tpl").clone());h.attr("id","publish-main-img-label"),h.removeClass("hide"),$("#publish-main-img-label").remove(),g.append(h),resetPhotosPosition(),b.slick("slickGoTo",0)}}function resetPhotosPosition(){$.each($("#publish-img-slick").find(".publish-img"),function(a,b){var c=$(b),d=a+1;c.find("> a").attr("href","javascript:setMain("+d+")"),c.find(".publish-img-delete-btn > a").attr("href","javascript:deletePhoto("+d+")")})}function deletePhoto(a){var b=$("#publish-img-slick");b.slick("slickRemove",a),setMain(0),resetPhotosPosition()}function addCustomTag(a){if(a=$.trim(a),0===a.length)return void $("#add-tag-model").foundation("reveal","close");var b,c=$("#publish-main-img"),d=$("#add-tag-id").val();if("new"===d){var e=$("#custom-tag-tpl").clone();b=parseInt(1e3*Math.random()+1),e.attr("id",b),e.removeClass("hide"),c.append(e),c.find(".custom-tag").pep({useCSSTranslation:!1,constrainTo:"parent",stop:function(a){var b=$("#container").width(),c=$(a.target).parent(),d=$("#custom-tag-menu"),e=parseInt(c.css("left"))+(parseInt(c.css("width"))/2-50),f=parseInt(c.css("top"))-parseInt(d.css("height"));100>e?e=100:100>b-e&&(e=b-100),bindTagEditMenu(c,d),d.animate({left:e,top:f})}})}else b=d;var f=$("#"+b),g=parseInt($("#add-tag-y-input").val()),h=parseInt($("#add-tag-x-input").val()),i=parseInt($("#container").width()),j=12.8*a.length+38,k=36.8,l=h+j-i;l>0&&(h-=l),10>g&&(g=10),g>i-k&&(g=i-k),f.css("top",g+"px"),f.css("left",h+"px"),f.find(".txt").html(a);var m=JSON.parse(localStorage.getItem(usedTags));m||(m=[]),m.length>10&&(m=m.splice(0,9)),m.indexOf(a)<0&&m.unshift(a),localStorage.setItem(usedTags,JSON.stringify(m)),f.hammer().bind("press",function(a){var b=$(a.target),c=$("#custom-tag-menu");c.show();var d=$("#container").width(),e=parseInt(b.css("left"))+(parseInt(b.css("width"))/2-50),f=parseInt(b.css("top"))-parseInt(c.css("height"));100>e?e=100:100>d-e&&(e=d-100),c.animate({left:e,top:f}),bindTagEditMenu(b,c),childTriggered=!0,a.stopPropagation()}),f.hammer().bind("tap",function(a){$("#custom-tag-menu").hide();var b=$(a.target),c=b.find(".dot"),d=b.find(".txt"),e=parseInt(c.css("left"));return 0===e?(c.animate({left:parseInt(d.css("width"))+4}),d.animate({"border-radius":"10px 0 10px 0"})):(c.animate({left:0}),d.animate({"border-radius":"0 10px 0 10px"})),a.stopPropagation(),childTriggered=!0,!1}),$("#add-tag-model").foundation("reveal","close")}function bindTagEditMenu(a,b){$(".current-editing-tag").removeClass("current-editing-tag"),a.addClass("current-editing-tag"),b.find(".leftside img").hammer().bind("tap",function(b){var c=$("#add-tag-model");c.foundation("reveal","open");var d=a.find(".txt").html();return $("#add-tag-x-input").val(parseInt(a.css("left"))),$("#add-tag-y-input").val(parseInt(a.css("top"))),$("#add-tag-id").val(a.attr("id")),$("#add-tag-input").find("input").val(d),$("#custom-tag-menu").hide(),$(".current-editing-tag").removeClass("current-editing-tag"),childTriggered=!0,b.stopPropagation(),!1}),b.find(".rightside img").hammer().bind("tap",function(a){return $(".current-editing-tag").remove(),$("#custom-tag-menu").hide(),childTriggered=!0,a.stopPropagation(),!1})}function gotoDataTagView(){$("#add-data-tag-panel");$("#publish-main-slick").slick("slickNext"),$("#hide-select-currency-panel").click(function(){var a=$("#select-currency-panel");a.animate({bottom:-188,left:0},function(){a.hide()})})}function gotoDescView(){$("#select-currency-panel").hide();var a=($("#add-data-tag-panel"),$("#add-desc-panel"));a.find(".row img").attr("src",$("#publish-main-img").find("> img").attr("src")),$("#publish-main-slick").slick("slickNext")}function showCurrencySelect(){var a=$("#select-currency-panel");a.show(),a.animate({bottom:0,left:0})}function selectCurrency(a,b){var c=$("#add-data-tag-panel");c.find("input[name=currency]").val(a),c.find('input[name="currency-label"]').val(b);var d=$("#select-currency-panel");d.animate({bottom:-188,left:0},function(){d.hide()})}function publish(){var a=$("#publish-commodity-btn");a.unbind();var b=[],c=$("#publish-img-slick").find(".publish-img");$.each(c,function(a,c){var d=$(c).css("background-image").replace("url(","").replace("!thumb)","");b.push(d)});var d=[],e=$("#publish-main-img").find(".custom-tag"),f=$("#container").width();$.each(e,function(a,b){var c=$(b),e=c.find(".txt").html(),g=parseInt(c.find(".dot").css("left")),h=parseInt(c.css("left").replace("px","")),i=parseInt(c.css("top").replace("px",""));d.push({txt:e,x:h/f,y:i/f,o:0===g?"l":"r"})});var g=$("input[name=works]").val(),h=$("input[name=ip]").val(),i=$("input[name=brand]").val(),j=$("input[name=title]").val(),k=$("input[name=currency]").val(),l=$("input[name=price]").val(),m=$("input[name=url]").val(),n=$("textarea[name=desc]").val(),o={images:b,tags:d,works:g,ip:h,brand:i,title:j,currency:k,price:l,url:m,desc:n},p="/publish";$.post(p,{data:o},function(b){b.err?(alertMessage("发布失败","发布好像出问题了",MOODs.blackline),a.click(function(){publish()})):window.location.href="/commodities/"+b.result.id+"#status=new"})}var publishData=null,childTriggered=!1,isShowTip=!0,usedTags="moretao-used-tags";$(document).ready(function(){showReturnArrow("/publish"),$("#alert-auto-hide-panel").css("display","none"),$("#publish-click-tip").bind("tap click",function(a){a.stopPropagation(),a.preventDefault(),isShowTip=!1,$("#publish-click-tip").remove()});var a=$("#publish-main-img"),b=a.find("> img");b.attr("data-original",url("#main",window.location.href)+"!content");var c=$("#container");b.css("width",c.width()),b.css("height",c.width());var d=$("#publish-img-slick").find(".publish-img:first");d.css("background",'url("'+url("#main",window.location.href)+'!thumb") no-repeat'),d.css("background-size","contain");var e=$($("#publish-main-img-label-tpl").clone());e.attr("id","publish-main-img-label"),e.removeClass("hide"),d.append(e),$("img.lazy").lazyload({container:b,effect:"fadeIn"}),a.find(".custom-tag").pep({useCSSTranslation:!1,constrainTo:"parent"}),a.hammer().bind("tap",function(a){if(isShowTip)return!1;if(childTriggered)return childTriggered=!1,!1;$("#custom-tag-menu").hide();var b=a.gesture.pointers[0];$("#add-tag-x-input").val(b.clientX),$("#add-tag-y-input").val(b.clientY);var c=$("#add-tag-model");return $("#add-tag-input").find("input").val(""),$("#add-tag-id").val("new"),c.foundation("reveal","open"),!0}),$("#publish-img-input").change(function(){var a=$("#progress-model-panel");a.find(".progress-bar").css("width","0%"),a.foundation("open"),$(document).on("opened.fndtn.reveal","[data-reveal]",function(){a.find(".progress-bar").animate({width:"90%"},5e3)});var b="/api/photos/upload/signature",c=document.getElementById("publish-img-input").files[0],d=Math.floor((new Date).getTime()/1e3)+86400;$.post(b,{filename:c.name,expiration:d},function(b){var d=new FormData;d.append("policy",b.policy),d.append("signature",b.signature),d.append("file",c),d.append("x-gmkerl-rotate","auto"),$.ajax({url:"http://v0.api.upyun.com/moretao-dev",type:"POST",data:d,mimeType:"multipart/form-data",contentType:!1,cache:!1,processData:!1,success:function(b,c,d){a.find(".progress-bar").animate({width:"100%"},function(){$("#progress-model-panel").foundation("close");var a=JSON.parse(b),c="http://dev.images.moretao.com"+a.url+"!thumb",d=$("#publish-img-tpl").clone();d.attr("id",null),d.removeClass("hide"),d.css("background","url("+c+") no-repeat"),d.css("background-size","contain");var e=$("#publish-img-slick");e.slick("slickAdd",d),e.slick("slickGoTo",e.find(".publish-img").length),resetPhotosPosition()})}})})});var f=JSON.parse(localStorage.getItem(usedTags));if(f&&f.length>0){var g=$("#used-tags-area");$.each(f,function(a,b){g.append('<div onclick="addCustomTag($(this).html())">'+b+"</div>")})}autosize($("#desc-textarea")),$("#add-tag-background").click(function(){$("#add-tag-model").foundation("reveal","close")}),setTimeout(function(){html2canvas(document.body,{proxy:"/api/outdata"}).then(function(a){makeBlurBg(a),$("#add-tag-background img").attr("src",a.toDataURL()),$("#add-data-tag-background img").attr("src",a.toDataURL())})},1e3)});var autoComplete,setAutoCompleteTop2=document.getElementById("get-ip-top-value").offsetTop/5.3,setAutoCompleteTop1=document.getElementById("get-works-top-value").offsetTop/8,allelement=["publish-work-div","publish-ip-div","publish-brand-div","publish-currency-div","publish-price-div","publish-name-div","up-btn","next-btn"];